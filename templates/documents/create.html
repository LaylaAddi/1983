{% extends 'base.html' %}

{% block title %}Create New Document - Section 1983 Document Generator{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h2 class="mb-0"><i class="fas fa-plus-circle"></i> Create New Document</h2>
                    <p class="mb-0 opacity-75">Generate a Section 1983 civil rights complaint</p>
                </div>
                <div class="card-body">
                    <!-- Legal Disclaimer -->
                    <div class="alert alert-warning" role="alert">
                        <h6 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Legal Disclaimer</h6>
                        This tool generates draft legal documents only. Always consult with a qualified attorney
                        before filing any legal documents in court.
                    </div>

                    <!-- Getting Started Info -->
                    <div class="alert alert-info" role="alert">
                        <h6 class="alert-heading"><i class="fas fa-info-circle"></i> Getting Started</h6>
                        <p class="mb-2">Provide details about your civil rights incident below. After creating your
                            document, you can:</p>
                        <ul class="mb-2">
                            <li>Use auto-generation to create basic legal sections</li>
                            <li>Manually edit and customize legal sections</li>
                            <li>Preview your court-ready document</li>
                            <li>Print or save your completed complaint</li>
                        </ul>
                        <small><strong>Required fields are marked with a red asterisk (*)</strong></small>
                    </div>

                    <!-- Form Errors -->
                    {% if form.errors %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <h6 class="alert-heading"><i class="fas fa-exclamation-circle"></i> Please correct the errors below</h6>
                        <ul class="mb-0">
                            {% for field in form %}
                                {% if field.errors %}
                                    <li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>
                                {% endif %}
                            {% endfor %}
                            {% if form.non_field_errors %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            {% endif %}
                        </ul>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endif %}

                    <form method="post" novalidate>
                        {% csrf_token %}
<!-- <div style="background: yellow; padding: 10px;">
    DEBUG - Available form fields:<br>
    {% for field in form %}
        {{ field.name }}<br>
    {% endfor %}
</div> -->
                        <!-- Case Title -->
                        <div class="mb-4">
                            <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-file-alt text-primary"></i> Document Title
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.title }}
                            {% if form.title.help_text %}
                            <div class="form-text">{{ form.title.help_text }}</div>
                            {% endif %}
                            {% if form.title.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.title.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        <div class="mb-4">
                            <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-comment-alt text-primary"></i> Incident Description
                                <span class="text-danger">*</span>
                            </label>
                            {{ form.description }}
                            {% if form.description.help_text %}
                            <div class="form-text">{{ form.description.help_text }}</div>
                            {% endif %}
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.description.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Incident Date and Location Section -->
                        <div class="card border-primary mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Incident Location & Date</h5>
                                <small>This information helps determine the correct federal court jurisdiction</small>
                            </div>
                            <div class="card-body">
                                <!-- Incident Date -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.incident_date.id_for_label }}" class="form-label fw-bold">
                                            <i class="fas fa-calendar text-primary"></i> Incident Date
                                        </label>
                                        {{ form.incident_date }}
                                        {% if form.incident_date.help_text %}
                                        <div class="form-text">{{ form.incident_date.help_text }}</div>
                                        {% endif %}
                                        {% if form.incident_date.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.incident_date.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Structured Address Fields -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label for="{{ form.incident_street_address.id_for_label }}" class="form-label fw-bold">
                                            <i class="fas fa-road text-primary"></i> Street Address
                                        </label>
                                        {{ form.incident_street_address }}
                                        {% if form.incident_street_address.help_text %}
                                        <div class="form-text">{{ form.incident_street_address.help_text }}</div>
                                        {% endif %}
                                        {% if form.incident_street_address.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.incident_street_address.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="{{ form.incident_city.id_for_label }}" class="form-label fw-bold">
                                            <i class="fas fa-city text-primary"></i> City
                                            <span class="text-danger">*</span>
                                        </label>
                                        {{ form.incident_city }}
                                        {% if form.incident_city.help_text %}
                                        <div class="form-text">{{ form.incident_city.help_text }}</div>
                                        {% endif %}
                                        {% if form.incident_city.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.incident_city.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <label for="{{ form.incident_state.id_for_label }}" class="form-label fw-bold">
                                            <i class="fas fa-flag text-primary"></i> State
                                            <span class="text-danger">*</span>
                                        </label>
                                        {{ form.incident_state }}
                                        {% if form.incident_state.help_text %}
                                        <div class="form-text">{{ form.incident_state.help_text }}</div>
                                        {% endif %}
                                        {% if form.incident_state.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.incident_state.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <label for="{{ form.incident_zip_code.id_for_label }}" class="form-label fw-bold">
                                            <i class="fas fa-mail-bulk text-primary"></i> ZIP Code
                                        </label>
                                        {{ form.incident_zip_code }}
                                        {% if form.incident_zip_code.help_text %}
                                        <div class="form-text">{{ form.incident_zip_code.help_text }}</div>
                                        {% endif %}
                                        {% if form.incident_zip_code.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.incident_zip_code.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Additional Location Details -->
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label for="{{ form.incident_location.id_for_label }}" class="form-label">
                                            <i class="fas fa-info-circle text-secondary"></i> Additional Location Details (optional)
                                        </label>
                                        {{ form.incident_location }}
                                        {% if form.incident_location.help_text %}
                                        <div class="form-text">{{ form.incident_location.help_text }}</div>
                                        {% endif %}
                                        {% if form.incident_location.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.incident_location.errors %}
                                            {{ error }}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <h6><i class="fas fa-lightbulb"></i> Why we need this information:</h6>
                                    <p class="mb-2">The incident location determines which federal district court has
                                        jurisdiction over your case. Our system will:</p>
                                    <ul class="mb-0">
                                        <li>Automatically suggest the correct federal district court</li>
                                        <li>Generate proper court headers in your legal documents</li>
                                        <li>Help ensure your case is filed in the right jurisdiction</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Defendants -->
                        <div class="mb-4">
                            <label for="{{ form.defendants.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-users text-primary"></i> Defendants
                            </label>
                            {{ form.defendants }}
                            {% if form.defendants.help_text %}
                            <div class="form-text">{{ form.defendants.help_text }}</div>
                            {% endif %}
                            {% if form.defendants.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.defendants.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

              

                        <!-- Additional Evidence -->
                        <div class="mb-4">
                            <label for="{{ form.additional_evidence.id_for_label }}" class="form-label fw-bold">
                                <i class="fas fa-folder-open text-primary"></i> Additional Evidence
                            </label>
                            {{ form.additional_evidence }}
                            {% if form.additional_evidence.help_text %}
                            <div class="form-text">{{ form.additional_evidence.help_text }}</div>
                            {% endif %}
                            {% if form.additional_evidence.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.additional_evidence.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Next Steps Info -->
                        <div class="alert alert-success" role="alert">
                            <h6 class="alert-heading"><i class="fas fa-check-circle"></i> After Creating Your Document</h6>
                            <p class="mb-2">Once you create this document, you'll be able to:</p>
                            <ul class="mb-0">
                                <li>Auto-generate legal sections based on your incident details</li>
                                <li>Manually edit and customize each section of your complaint</li>
                                <li>Preview your document in court-ready format</li>
                                <li>Print or download your completed legal document</li>
                            </ul>
                        </div>

                        <!-- Form Actions -->
                        <div class="card bg-body-secondary mt-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="{% url 'document_list' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left"></i> Back to Documents
                                    </a>
                                    <div>
                                        <button type="submit" class="btn btn-success btn-lg">
                                            <i class="fas fa-plus-circle"></i> Create Document
                                        </button>
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    <i class="fas fa-info-circle"></i> Your document will be saved as a draft. You can edit and add legal sections after creation.
                                </small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Transcript extraction functionality
let extractedTranscripts = { 1: '', 2: '', 3: '', 4: '' };

function extractTranscript(videoNum) {
    console.log('Extract called for video:', videoNum);
    
    const urlField = document.getElementById('id_youtube_url_' + videoNum);
    const startField = document.getElementById('id_youtube_url_' + videoNum + '_start_time');
    const endField = document.getElementById('id_youtube_url_' + videoNum + '_end_time');
    const button = event.target.closest('button');
    
    if (!urlField || !startField || !endField) {
        console.error('Fields not found:', urlField, startField, endField);
        alert('Error: Form fields not found');
        return;
    }

    const url = urlField.value.trim();
    const startTime = startField.value.trim() || '0';
    const endTime = endField.value.trim() || '30';

    if (!url) {
        alert('Please enter a YouTube URL first');
        return;
    }

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Extracting...';

    fetch('{% url "extract_transcript_whisper" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            youtube_url: url,
            start_time: startTime,
            end_time: endTime
        })
    })
    .then(response => response.json())
    .then(data => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-download"></i> Extract Transcript';

   if (data.success) {
    extractedTranscripts[videoNum] = data.text;

    const previewDiv = document.getElementById('transcript-preview-' + videoNum);
    const textDiv = document.getElementById('transcript-text-' + videoNum);

    // No more mock badge
    textDiv.innerHTML = data.text + 
        '<div class="mt-2 small text-muted">Cost: $' + data.cost_estimate + 
        ' | Duration: ~' + data.duration_minutes + ' min</div>';
    previewDiv.style.display = 'block';

    document.getElementById('id_youtube_url_' + videoNum + '_transcript').value = data.text;
} else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-download"></i> Extract Transcript';
        alert('Error extracting transcript: ' + error);
        console.error('Fetch error:', error);
    });
}

function useTranscript(videoNum, target) {
    const transcript = extractedTranscripts[videoNum];
    if (!transcript) return;

    const startTime = document.getElementById('id_youtube_url_' + videoNum + '_start_time').value || '0:00';
    const endTime = document.getElementById('id_youtube_url_' + videoNum + '_end_time').value || '0:30';

    const timestampNote = `\n\n[Video ${videoNum} Transcript - ${startTime} to ${endTime}]\n${transcript}\n`;

    if (target === 'description') {
        const descField = document.getElementById('id_description');
        descField.value += timestampNote;
        descField.scrollIntoView({ behavior: 'smooth' });
    } else if (target === 'evidence') {
        const evidenceField = document.getElementById('id_additional_evidence');
        evidenceField.value += timestampNote;
        evidenceField.scrollIntoView({ behavior: 'smooth' });
    }

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> Added!';
    setTimeout(() => {
        btn.innerHTML = originalText;
    }, 2000);
}

function fillTestData() {
    document.getElementById('id_youtube_url_1').value = 'https://www.youtube.com/watch?v=jNQXAC9IVRw';
    document.getElementById('id_youtube_url_1_start_time').value = '0';
    document.getElementById('id_youtube_url_1_end_time').value = '10';
    alert('Test data filled - 10 second clip from "Me at the zoo"');
}
</script>

{% endblock %}
