{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Legal Sections - {{ document.title }}{% endblock %}

{% block extra_css %}
<style>
    /* Keep this - important for legal documents */
    .section-content {
        font-family: "Times New Roman", serif;
        line-height: 1.6;
        min-height: 200px;
    }

    /* Keep this - custom button color for legal theme */
    .btn-legal {
        background: #1a472a;
        color: white;
        border: none;
    }

    .btn-legal:hover {
        background: #0f2818;
        color: white;
    }

    /* Make delete checkbox visible and styled */
    .form-check-input[type="checkbox"] {
        width: 1.5em;
        height: 1.5em;
        cursor: pointer;
    }

    .form-check-label {
        cursor: pointer;
        margin-left: 0.5em;
    }

    .section-card {
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background: var(--bs-body-bg);
        transition: opacity 0.3s ease, border 0.3s ease;
    }

    .section-card.marked-for-deletion {
        opacity: 0.5;
        border: 2px solid #dc3545;
        background: rgba(220, 53, 69, 0.1);
    }

    .section-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--bs-border-color);
    }

    .section-body {
        padding: 10px 0;
    }

    .deletion-notice {
        display: none;
        position: sticky;
        top: 20px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>Manage Legal Sections</h2>
                    <p class="text-muted">{{ document.title }}</p>
                </div>
                <div>
                    <a href="{% url 'document_preview' document.pk %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-eye"></i> Preview Document
                    </a>
                    <a href="{% url 'document_detail' document.pk %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Document
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Card -->
    <div class="card mb-4 border-info">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Understanding Legal Document Sections</h5>
        </div>
        <div class="card-body">
            <div class="alert alert-primary">
                <h6 class="mb-2"><i class="fas fa-gavel"></i> Why Are These 7 Sections Required?</h6>
                <p class="mb-2">Federal courts require Section 1983 civil rights complaints to follow a specific format. These 7 sections are the standard legal structure that judges expect to see:</p>
                <ol class="mb-0">
                    <li><strong>Introduction</strong> - Tells the court this is a civil rights case</li>
                    <li><strong>Jurisdiction</strong> - Explains why this federal court can hear your case</li>
                    <li><strong>Parties</strong> - Identifies you (plaintiff) and who violated your rights (defendants)</li>
                    <li><strong>Statement of Facts</strong> - Describes exactly what happened</li>
                    <li><strong>Claims for Relief</strong> - Explains which constitutional rights were violated</li>
                    <li><strong>Prayer for Relief</strong> - States what you want the court to award you</li>
                    <li><strong>Jury Demand</strong> - Requests your right to a jury trial</li>
                </ol>
                <p class="mt-2 mb-0"><small><strong>Important:</strong> Even if a section appears "empty" or basic, it serves a legal purpose. Courts can dismiss cases that don't include these required sections.</small></p>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary">How to Fill Sections:</h6>
                    <ul class="small">
                        <li><strong>Use "Smart Auto-Populate"</strong> (from document detail page) - Analyzes your case and writes customized legal language</li>
                        <li><strong>Insert Legal Template</strong> (below) - Choose specific templates based on your violation type and location</li>
                        <li><strong>Add Blank Section</strong> (below) - Create empty section to write yourself</li>
                        <li><strong>Edit Directly</strong> - Click in any section below to customize the text</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-primary">Violation & Location Types:</h6>
                    <ul class="small">
                        <li><strong>Threatened Arrest in Public:</strong> Officer threatened to arrest you for lawful activities</li>
                        <li><strong>Interference with Recording:</strong> Officials blocked or stopped your recording</li>
                        <li><strong>Forced to Leave Public Area:</strong> You were unlawfully removed from public property</li>
                    </ul>
                    <ul class="small">
                        <li><strong>Traditional Public Forum:</strong> Sidewalks, streets, parks</li>
                        <li><strong>Designated Public Forum:</strong> Government buildings open to public</li>
                        <li><strong>Limited Public Forum:</strong> Restricted areas like lobbies</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Section Tools -->
    <div class="template-section">
        <h4><i class="fas fa-plus-circle"></i> Add New Section</h4>
        
        <div class="row">
            <!-- Insert Template Section -->
            <div class="col-md-6">
                <h6>Insert Legal Template</h6>
                <form method="post" action="{% url 'insert_template_section' document.pk %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ template_form.violation_type.label_tag }}
                        {{ template_form.violation_type }}
                    </div>
                    <div class="mb-3">
                        {{ template_form.location_type.label_tag }}
                        {{ template_form.location_type }}
                    </div>
                    <div class="mb-3">
                        {{ template_form.section_type.label_tag }}
                        {{ template_form.section_type }}
                    </div>
                    <button type="submit" class="btn btn-legal">
                        <i class="fas fa-file-alt"></i> Insert Template
                    </button>
                </form>
            </div>
            
            <!-- Add Blank Section -->
            <div class="col-md-6">
                <h6>Add Blank Section</h6>
                <form method="post" action="{% url 'add_blank_section' document.pk %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        {{ blank_form.section_type.label_tag }}
                        {{ blank_form.section_type }}
                    </div>
                    <div class="mb-3">
                        {{ blank_form.title.label_tag }}
                        {{ blank_form.title }}
                    </div>
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="fas fa-plus"></i> Add Blank Section
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Deletion Notice (shown when sections marked for deletion) -->
    <div id="deletionNotice" class="alert alert-warning deletion-notice">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Sections marked for deletion!</strong>
                <span id="deletionCount">0</span> section(s) will be permanently deleted.
            </div>
            <button type="button" class="btn btn-danger" onclick="document.getElementById('sectionManagementForm').submit();">
                <i class="fas fa-save"></i> Save Changes Now
            </button>
        </div>
    </div>

    <!-- Section Management Form -->
    <form method="post" id="sectionManagementForm">
        {% csrf_token %}
        {{ formset.management_form }}

        <div class="row">
            <div class="col-12">
                <h4><i class="fas fa-edit"></i> Edit Existing Sections</h4>

                {% if formset.non_form_errors %}
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Form Errors:</h6>
                        {{ formset.non_form_errors }}
                    </div>
                {% endif %}

                {% if formset.errors %}
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle"></i> Please check the sections below for errors</h6>
                        <p class="mb-0 small">Some sections have validation errors. Scroll down to see which fields need correction.</p>
                    </div>
                {% endif %}

                {% if formset.forms %}
                    {% for form in formset.forms %}
                        <div class="section-card">
                            <div class="section-header">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h5 class="mb-0">
                                            {% if form.instance.section_type %}
                                                {{ form.instance.get_section_type_display }}
                                                {% if form.instance.content and '[Enter your content here]' in form.instance.content or '[DESCRIPTION TO BE ADDED]' in form.instance.content or '[SPECIFIC VIOLATIONS TO BE DETAILED]' in form.instance.content %}
                                                    <span class="badge bg-warning text-dark ms-2">Needs Editing</span>
                                                {% elif form.instance.is_complete %}
                                                    <span class="badge bg-success ms-2">Complete</span>
                                                {% else %}
                                                    <span class="badge bg-secondary ms-2">{{ form.instance.completion_percentage }}%</span>
                                                {% endif %}
                                            {% else %}
                                                Section {{ forloop.counter }}
                                            {% endif %}
                                        </h5>
                                        <small class="text-muted">Automatically ordered according to legal document standards</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        {% if form.DELETE %}
                                            <div class="form-check form-switch d-inline-block">
                                                {{ form.DELETE }}
                                                <label class="form-check-label text-danger fw-bold" for="{{ form.DELETE.id_for_label }}">
                                                    <i class="fas fa-trash-alt"></i> Delete Section
                                                </label>
                                            </div>
                                            <div class="small text-muted mt-1">
                                                <i class="fas fa-info-circle"></i> Toggle to mark, then scroll down and click "Save All Changes"
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section-body">
                                <!-- Show any form-level errors -->
                                {% if form.non_field_errors %}
                                    <div class="alert alert-danger mb-3">
                                        {{ form.non_field_errors }}
                                    </div>
                                {% endif %}

                                <!-- Hidden fields -->
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                    {% if hidden.errors %}
                                        <div class="alert alert-danger small">
                                            <strong>{{ hidden.label }}:</strong> {{ hidden.errors }}
                                        </div>
                                    {% endif %}
                                {% endfor %}

                                <div class="mb-3">
                                    {{ form.title.label_tag }}
                                    {{ form.title }}
                                    {% if form.title.errors %}
                                        <div class="text-danger">{{ form.title.errors }}</div>
                                    {% endif %}
                                </div>

                                <div class="mb-3">
                                    {{ form.content.label_tag }}
                                    {{ form.content }}
                                    {% if form.content.errors %}
                                        <div class="text-danger">{{ form.content.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-legal btn-lg">
                            <i class="fas fa-save"></i> Save All Changes
                        </button>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <h5>No sections yet</h5>
                        <p>This document doesn't have any sections yet. Use the tools above to add legal templates or create blank sections.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<script>
// Auto-resize textareas and enforce standard legal ordering
document.addEventListener('DOMContentLoaded', function() {
    // Standard legal document order
    const standardOrder = {
        'introduction': 1,
        'jurisdiction': 2,
        'parties': 3,
        'facts': 4,
        'claims': 5,
        'prayer': 6,
        'jury_demand': 7
    };
    
    const textareas = document.querySelectorAll('.section-content');
    textareas.forEach(function(textarea) {
        // Initial resize
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
        
        // Resize on input
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    });
    
    // Function to enforce standard legal ordering
    function enforceStandardOrdering() {
        const orderInputs = document.querySelectorAll('input[name$="-order"]:not([name*="__prefix__"])');
        const deleteCheckboxes = document.querySelectorAll('input[name$="-DELETE"]');
        
        orderInputs.forEach(function(input, index) {
            const deleteCheckbox = deleteCheckboxes[index];
            
            // Skip if marked for deletion
            if (deleteCheckbox && deleteCheckbox.checked) {
                return;
            }
            
            // Find the section type for this input
            const formContainer = input.closest('.section-card');
            if (formContainer) {
                const sectionTypeInput = formContainer.querySelector('input[name$="-section_type"]');
                if (sectionTypeInput) {
                    const sectionType = sectionTypeInput.value;
                    const standardPosition = standardOrder[sectionType];
                    
                    if (standardPosition) {
                        input.value = standardPosition;
                        input.readOnly = true;
                        input.style.backgroundColor = '#e9ecef';
                        input.title = 'Position automatically set based on legal document standards';
                    }
                }
            }
        });
        
        // Sort the section cards by their standard order
        const sectionContainer = document.querySelector('form[method="post"]');
        if (sectionContainer) {
            const sectionCards = Array.from(sectionContainer.querySelectorAll('.section-card'));
            
            sectionCards.sort(function(a, b) {
                const aTypeInput = a.querySelector('input[name$="-section_type"]');
                const bTypeInput = b.querySelector('input[name$="-section_type"]');
                const aDeleteCheckbox = a.querySelector('input[name$="-DELETE"]');
                const bDeleteCheckbox = b.querySelector('input[name$="-DELETE"]');
                
                // Put deleted sections at the end
                if (aDeleteCheckbox && aDeleteCheckbox.checked) return 1;
                if (bDeleteCheckbox && bDeleteCheckbox.checked) return -1;
                
                if (aTypeInput && bTypeInput) {
                    const aOrder = standardOrder[aTypeInput.value] || 999;
                    const bOrder = standardOrder[bTypeInput.value] || 999;
                    return aOrder - bOrder;
                }
                return 0;
            });
            
            // Reorder the DOM elements
            const saveButton = sectionContainer.querySelector('button[type="submit"]');
            sectionCards.forEach(function(card) {
                sectionContainer.insertBefore(card, saveButton);
            });
        }
    }
    
    // Function to update deletion notice
    function updateDeletionNotice() {
        const deleteCheckboxes = document.querySelectorAll('input[name$="-DELETE"]:checked');
        const deletionNotice = document.getElementById('deletionNotice');
        const deletionCount = document.getElementById('deletionCount');

        if (deleteCheckboxes.length > 0) {
            deletionCount.textContent = deleteCheckboxes.length;
            deletionNotice.style.display = 'block';
        } else {
            deletionNotice.style.display = 'none';
        }
    }

    // Confirmation for deletes and reorder after deletion
    const deleteCheckboxes = document.querySelectorAll('input[name$="-DELETE"]');
    deleteCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                const sectionCard = this.closest('.section-card');
                const sectionName = sectionCard.querySelector('h5').textContent.trim();

                if (!confirm('Mark "' + sectionName + '" for deletion?\n\nClick "Save All Changes" at the bottom to permanently delete.')) {
                    this.checked = false;
                } else {
                    // Mark the section visually
                    if (sectionCard) {
                        sectionCard.classList.add('marked-for-deletion');

                        // Disable inputs in marked section
                        const inputs = sectionCard.querySelectorAll('input:not([name$="-DELETE"]), textarea');
                        inputs.forEach(input => input.disabled = true);
                    }
                    enforceStandardOrdering();
                    updateDeletionNotice();
                }
            } else {
                // Restore the section
                const sectionCard = this.closest('.section-card');
                if (sectionCard) {
                    sectionCard.classList.remove('marked-for-deletion');

                    // Re-enable inputs
                    const inputs = sectionCard.querySelectorAll('input, textarea');
                    inputs.forEach(input => input.disabled = false);
                }
                enforceStandardOrdering();
                updateDeletionNotice();
            }
        });
    });

    // Initial check for any pre-checked delete boxes
    updateDeletionNotice();

    // Before form submission, re-enable all disabled inputs so they submit properly
    const sectionForm = document.getElementById('sectionManagementForm');
    if (sectionForm) {
        sectionForm.addEventListener('submit', function(e) {
            // Re-enable all inputs in marked-for-deletion sections
            // Django needs them enabled to process the deletion
            const markedSections = document.querySelectorAll('.section-card.marked-for-deletion');
            markedSections.forEach(function(section) {
                const inputs = section.querySelectorAll('input:disabled, textarea:disabled');
                inputs.forEach(input => {
                    // Don't re-enable the delete checkbox itself
                    if (!input.name.endsWith('-DELETE')) {
                        input.disabled = false;
                    }
                });
            });
        });
    }
    
    // Remove order input change handlers since we're enforcing standard order
    const orderInputs = document.querySelectorAll('input[name$="-order"]');
    orderInputs.forEach(function(input) {
        input.addEventListener('focus', function() {
            alert('Section order is automatically set based on legal document standards.\n\nStandard Order:\n1. Introduction\n2. Jurisdiction & Venue\n3. Parties\n4. Statement of Facts\n5. Claims for Relief\n6. Prayer for Relief\n7. Jury Trial Demand');
            this.blur();
        });
    });
    
    // Initial enforcement of standard ordering
    enforceStandardOrdering();
});
</script>
{% endblock %}