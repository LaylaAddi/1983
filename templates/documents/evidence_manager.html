{% extends 'base.html' %}

{% block title %}Video Evidence Manager - {{ document.title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-video text-danger"></i> Video Evidence Manager</h2>
                    <p class="text-muted">{{ document.title }}</p>
                </div>
                <div class="d-flex gap-2">
                    {% if included_count > 0 %}
                    <a href="{% url 'generate_facts_from_evidence' document.pk %}" class="btn btn-success" onclick="return confirm('Add video evidence to Statement of Facts?\n\n✓ Tagged quotes will be converted to narrative paragraphs\n✓ Will be ADDED to your existing Statement of Facts (not replaced)\n✓ A separate \'List of Exhibits\' section will be created\n\nContinue?')">
                        <i class="fas fa-plus-circle"></i> Add Video Evidence to Statement of Facts
                    </a>
                    {% endif %}
                    <a href="{% url 'document_detail' document.pk %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Document
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow Guide -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="alert alert-info">
                <h5 class="alert-heading"><i class="fas fa-list-ol"></i> How This Works</h5>
                <div class="row">
                    <div class="col-md-3">
                        <strong>1. Extract or Enter</strong>
                        <p class="small mb-0">Add video evidence using AI extraction or manual entry</p>
                    </div>
                    <div class="col-md-3">
                        <strong>2. Edit & Tag Quotes</strong>
                        <p class="small mb-0">Highlight important quotes and assign speakers (plaintiff, defendants, witnesses)</p>
                    </div>
                    <div class="col-md-3">
                        <strong>3. Mark for Inclusion</strong>
                        <p class="small mb-0">Check "Include in Complaint" for segments you want in your legal document</p>
                    </div>
                    <div class="col-md-3">
                        <strong>4. Generate</strong>
                        <p class="small mb-0">Click the green button to add video evidence to Statement of Facts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Important Notice -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Important: AI Transcript Limitations</h5>
                <ul class="mb-2">
                    <li><strong>Not 100% accurate:</strong> AI transcription may mishear words, especially with background noise or accents</li>
                    <li><strong>No speaker identification:</strong> Transcripts don't identify who is speaking. You must manually add "Officer Smith:", "Plaintiff:", etc.</li>
                    <li><strong>YouTube blocking:</strong> Some videos cannot be downloaded due to privacy settings or regional restrictions</li>
                    <li><strong>Review required:</strong> Always review and edit transcripts before including them in legal documents</li>
                    <li><strong>Manual entry available:</strong> If extraction fails, you can manually type or paste transcripts</li>
                </ul>
                <p class="mb-0"><strong>Best practice:</strong> Extract the raw transcript, then carefully edit it while watching the video to ensure accuracy and add speaker attribution.</p>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-primary">{{ total_segments }}</h3>
                    <small class="text-muted">Total Segments</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-success">{{ reviewed_count }}</h3>
                    <small class="text-muted">Reviewed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-info">{{ included_count }}</h3>
                    <small class="text-muted">Included in Complaint</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h3 class="text-warning">{{ total_segments|add:"-"|add:reviewed_count }}</h3>
                    <small class="text-muted">Needs Review</small>
                </div>
            </div>
        </div>
    </div>

    <!-- People Management Panel (NEW - for speaker attribution) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-users"></i> People Involved (Speaker Attribution)
                    </h5>
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#peoplePanel">
                        <i class="fas fa-chevron-down"></i> Toggle
                    </button>
                </div>
                <div class="collapse show" id="peoplePanel">
                    <div class="card-body">
                        <!-- Info Alert -->
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                            <strong><i class="fas fa-info-circle"></i> New Feature!</strong>
                            Tag who said what in your video transcripts for better organization and AI-generated citations.
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- Sync Button -->
                        {% if document.defendants %}
                        <div class="mb-3">
                            <button class="btn btn-primary" onclick="syncPeopleFromDefendants()">
                                <i class="fas fa-sync"></i> Auto-Sync People from Document Defendants
                            </button>
                            <small class="text-muted d-block mt-1">
                                This will create people from your defendants field: "{{ document.defendants|truncatechars:100 }}"
                            </small>
                        </div>
                        {% endif %}

                        <!-- People List -->
                        <div id="peopleList" class="row g-2 mb-3">
                            {% if has_people %}
                                {% for person in people %}
                                <div class="col-md-4" data-person-id="{{ person.id }}">
                                    <div class="card h-100" style="border-left: 4px solid {{ person.color_code }};">
                                        <div class="card-body p-2">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-0">{{ person.display_name }}</h6>
                                                    <small class="text-muted">{{ person.get_role_display }}</small>
                                                    {% if person.badge_number %}
                                                    <br><small class="text-muted">Badge: {{ person.badge_number }}</small>
                                                    {% endif %}
                                                </div>
                                                <div class="btn-group-vertical btn-group-sm">
                                                    <button class="btn btn-outline-primary btn-sm" onclick="editPerson({{ person.id }})" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" onclick="deletePerson({{ person.id }})" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i> No people added yet.
                                        {% if document.defendants %}
                                        Click "Auto-Sync" above to get started!
                                        {% else %}
                                        Add defendants to your document first, then sync.
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Add Person Button -->
                        <button class="btn btn-success btn-sm" onclick="showAddPersonModal()">
                            <i class="fas fa-plus"></i> Add Person Manually
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Segment -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Add Video Evidence Segment</h5>
                </div>
                <div class="card-body">
                    <!-- Tab Navigation -->
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#extract-tab">
                                <i class="fas fa-robot"></i> AI Extract
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#manual-tab">
                                <i class="fas fa-keyboard"></i> Manual Entry
                            </a>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- AI Extract Tab -->
                        <div class="tab-pane fade show active" id="extract-tab">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">YouTube URL</label>
                                    <input type="url" id="new-url" class="form-control" placeholder="https://www.youtube.com/watch?v=...">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Video Source <span class="text-danger">*</span></label>
                                    <select id="new-source-type" class="form-select">
                                        <option value="">-- Select Source --</option>
                                        <option value="body_camera">Body Camera Footage</option>
                                        <option value="plaintiff_recorded">Plaintiff-Recorded Video</option>
                                        <option value="surveillance">Surveillance Camera</option>
                                        <option value="dashboard_camera">Dashboard Camera</option>
                                        <option value="witness_recorded">Witness-Recorded Video</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Start Time <span class="text-danger">*</span>
                                        <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" title="Format: MM:SS or HH:MM:SS (e.g., 1:05:34). You can use periods - we'll fix them!"></i>
                                    </label>
                                    <input type="text" id="new-start" class="form-control" placeholder="MM:SS or HH:MM:SS" oninput="updateParsedTime('new-start', 'new-start-parsed')" onblur="autoFixTimeFormat('new-start')">
                                    <small class="text-muted" id="new-start-parsed"></small>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        End Time <span class="text-danger">*</span>
                                        <span class="badge bg-secondary ms-1">or use controls below</span>
                                    </label>
                                    <input type="text" id="new-end" class="form-control" placeholder="MM:SS or HH:MM:SS" oninput="updateParsedTime('new-end', 'new-end-parsed')" onblur="autoFixTimeFormat('new-end')">
                                    <small class="text-muted" id="new-end-parsed"></small>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Duration (seconds)
                                        <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" title="Auto-calculates end time from start time + duration"></i>
                                    </label>
                                    <input type="number" id="new-duration" class="form-control" placeholder="e.g., 30" min="1" onchange="updateEndFromDuration('new')">
                                    <small class="text-muted">Or: MM:SS format</small>
                                </div>
                            </div>
                            
                            <!-- Quick Duration Buttons -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label small text-muted">Quick Add to End Time:</label>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="addDuration('new', 5)">+5s</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addDuration('new', 10)">+10s</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addDuration('new', 30)">+30s</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addDuration('new', 60)">+1m</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addDuration('new', 300)">+5m</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <button type="button" class="btn btn-success" onclick="extractNewSegment()">
                                        <i class="fas fa-download"></i> Extract Transcript with AI
                                    </button>
                                </div>
                            </div>
                            <div id="extract-status" class="mt-2"></div>
                        </div>

                        <!-- Manual Entry Tab -->
                        <div class="tab-pane fade" id="manual-tab">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">YouTube URL</label>
                                    <input type="url" id="manual-url" class="form-control" placeholder="https://www.youtube.com/watch?v=...">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Video Source <span class="text-danger">*</span></label>
                                    <select id="manual-source-type" class="form-select">
                                        <option value="">-- Select Source --</option>
                                        <option value="body_camera">Body Camera Footage</option>
                                        <option value="plaintiff_recorded">Plaintiff-Recorded Video</option>
                                        <option value="surveillance">Surveillance Camera</option>
                                        <option value="dashboard_camera">Dashboard Camera</option>
                                        <option value="witness_recorded">Witness-Recorded Video</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        Start Time <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" id="manual-start" class="form-control" placeholder="MM:SS or HH:MM:SS" oninput="updateParsedTime('manual-start', 'manual-start-parsed')" onblur="autoFixTimeFormat('manual-start')">
                                    <small class="text-muted" id="manual-start-parsed"></small>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">
                                        End Time <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" id="manual-end" class="form-control" placeholder="MM:SS or HH:MM:SS" oninput="updateParsedTime('manual-end', 'manual-end-parsed')" onblur="autoFixTimeFormat('manual-end')">
                                    <small class="text-muted" id="manual-end-parsed"></small>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Duration (seconds)</label>
                                    <input type="number" id="manual-duration" class="form-control" placeholder="e.g., 30" min="1" onchange="updateEndFromDuration('manual')">
                                    <small class="text-muted">Or: MM:SS format</small>
                                </div>
                            </div>
                            
                            <!-- Quick Duration Buttons -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label class="form-label small text-muted">Quick Add to End Time:</label>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="addDuration('manual', 5)">+5s</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addDuration('manual', 10)">+10s</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addDuration('manual', 30)">+30s</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addDuration('manual', 60)">+1m</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="addDuration('manual', 300)">+5m</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Transcript Text</label>
                                    <textarea id="manual-transcript" class="form-control" rows="6" placeholder="Type or paste the transcript here. Add speaker attribution like 'Officer Smith: ...' and 'Plaintiff: ...'"></textarea>
                                    <small class="text-muted">Tip: Watch the video and type what you hear, adding speaker names for clarity.</small>
                                </div>
                                <div class="col-md-12">
                                    <button type="button" class="btn btn-primary" onclick="addManualSegment()">
                                        <i class="fas fa-plus"></i> Add Manual Segment
                                    </button>
                                </div>
                            </div>
                            <div id="manual-status" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evidence Segments List -->
    <div class="row">
        <div class="col-12">
            {% if segments_by_video %}
                {% for video_url, segments in segments_by_video.items %}
                <div class="card mb-4">
                    <div class="card-header bg-body-secondary">
                        <h5 class="mb-0">
                            <i class="fas fa-video text-danger"></i> 
                            {{ video_url|truncatechars:80 }}
                            <span class="badge bg-secondary ms-2">{{ segments|length }} segment{{ segments|length|pluralize }}</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for segment in segments %}
                        <div class="card mb-3 segment-card" data-segment-id="{{ segment.id }}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>Segment {{ forloop.counter }}: {{ segment.start_time }} - {{ segment.end_time }}</strong>
                                    {% if segment.manually_entered %}
                                        <span class="badge bg-info ms-2">Manual Entry</span>
                                    {% endif %}
                                    {% if segment.is_reviewed %}
                                        <span class="badge bg-success ms-2"><i class="fas fa-check"></i> Reviewed</span>
                                    {% endif %}
                                    {% if segment.include_in_complaint %}
                                        <span class="badge bg-primary ms-2"><i class="fas fa-file-alt"></i> In Complaint</span>
                                    {% endif %}
                                </div>
                                <div>
                                    <a href="{{ segment.youtube_embed_url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Watch segment">
                                        <i class="fas fa-play"></i> Watch
                                    </a>
                                    <button class="btn btn-sm btn-danger" onclick="deleteSegment({{ segment.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Raw Transcript (Read-only) -->
                                <div class="mb-3">
                                    <label class="form-label small text-muted">
                                        <i class="fas fa-lock"></i> Original Transcript (AI Generated - Read Only)
                                    </label>
                                    <div class="bg-body-secondary p-2 rounded small" style="max-height: 150px; overflow-y: auto;">
                                        {{ segment.raw_transcript }}
                                    </div>
                                </div>

                                <!-- Editable Transcript -->
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-edit"></i> Edited Transcript (Add speaker names, fix errors)
                                    </label>
                                    <textarea
                                        class="form-control edited-transcript"
                                        data-segment-id="{{ segment.id }}"
                                        rows="6"
                                        style="font-family: monospace;">{{ segment.edited_transcript }}</textarea>
                                    <small class="text-muted">
                                        Example: "Officer Smith: You need to show ID. Plaintiff: Am I being detained? Officer Smith: Yes, you're being detained."
                                    </small>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-info" onclick="enableHighlightMode({{ segment.id }})">
                                            <i class="fas fa-highlighter"></i> Highlight Text to Tag Speaker
                                        </button>
                                        <small class="text-muted ms-2">Select text in the transcript above, then click this button</small>
                                    </div>
                                </div>

                                <!-- Tagged Quotes Section (NEW) -->
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-quotes-left"></i> Tagged Quotes
                                        <span class="badge bg-secondary" id="quote-count-{{ segment.id }}">0</span>
                                    </label>
                                    <div id="quotes-list-{{ segment.id }}" class="border rounded p-2 bg-body-secondary" style="min-height: 100px; max-height: 300px; overflow-y: auto;">
                                        <p class="text-muted text-center mb-0"><i class="fas fa-info-circle"></i> No quotes tagged yet. Highlight text above to get started.</p>
                                    </div>
                                </div>

                                <!-- Violation Tags -->
                                <div class="mb-3">
                                    <label class="form-label">Violation Tags</label>
                                    <div class="btn-group-sm mb-2" role="group">
                                        <input type="checkbox" class="btn-check violation-tag" data-segment-id="{{ segment.id }}" data-tag="first_amendment" id="tag-1st-{{ segment.id }}" {% if 'first_amendment' in segment.violation_tags %}checked{% endif %}>
                                        <label class="btn btn-outline-primary" for="tag-1st-{{ segment.id }}">1st Amendment</label>

                                        <input type="checkbox" class="btn-check violation-tag" data-segment-id="{{ segment.id }}" data-tag="fourth_amendment" id="tag-4th-{{ segment.id }}" {% if 'fourth_amendment' in segment.violation_tags %}checked{% endif %}>
                                        <label class="btn btn-outline-primary" for="tag-4th-{{ segment.id }}">4th Amendment</label>

                                        <input type="checkbox" class="btn-check violation-tag" data-segment-id="{{ segment.id }}" data-tag="unlawful_detention" id="tag-detention-{{ segment.id }}" {% if 'unlawful_detention' in segment.violation_tags %}checked{% endif %}>
                                        <label class="btn btn-outline-primary" for="tag-detention-{{ segment.id }}">Unlawful Detention</label>

                                        <input type="checkbox" class="btn-check violation-tag" data-segment-id="{{ segment.id }}" data-tag="excessive_force" id="tag-force-{{ segment.id }}" {% if 'excessive_force' in segment.violation_tags %}checked{% endif %}>
                                        <label class="btn btn-outline-primary" for="tag-force-{{ segment.id }}">Excessive Force</label>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="mb-3">
                                    <label class="form-label">Notes</label>
                                    <textarea 
                                        class="form-control segment-notes" 
                                        data-segment-id="{{ segment.id }}"
                                        rows="2" 
                                        placeholder="Add context or notes about this segment...">{{ segment.notes }}</textarea>
                                </div>

                                <!-- Actions -->
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success" onclick="markReviewed({{ segment.id }}, {{ segment.is_reviewed|yesno:'false,true' }})">
                                        {% if segment.is_reviewed %}
                                            <i class="fas fa-times"></i> Mark as Not Reviewed
                                        {% else %}
                                            <i class="fas fa-check"></i> Mark as Reviewed
                                        {% endif %}
                                    </button>
                                    <div class="form-check form-switch">
                                        <input 
                                            class="form-check-input include-in-complaint-checkbox" 
                                            type="checkbox" 
                                            id="include-{{ segment.id }}"
                                            {% if segment.include_in_complaint %}checked{% endif %}
                                            onchange="toggleInclude({{ segment.id }}, this.checked)">
                                        <label class="form-check-label fw-bold" for="include-{{ segment.id }}">
                                            <i class="fas fa-file-alt"></i> Include in Complaint
                                        </label>
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="saveSegment({{ segment.id }})">
                                        <i class="fas fa-save"></i> Save Transcript & Notes
                                    </button>
                                </div>

                                {% if segment.extraction_cost %}
                                <div class="mt-2 small text-muted">
                                    Extraction cost: ${{ segment.extraction_cost }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> No Video Evidence Yet</h5>
                    <p class="mb-0">Use the form above to extract or manually add video evidence segments.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Sticky Action Bar (shows when segments selected) -->
<div id="sticky-action-bar" class="sticky-bottom bg-success text-white p-3 shadow-lg" style="display: none; z-index: 1000;">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i>
                    <span id="selected-count">0</span> segment<span id="plural-s">s</span> marked "Include in Complaint"
                </h5>
                <small>These tagged quotes will be added to your Statement of Facts as narrative paragraphs</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-light" onclick="previewFacts()" data-bs-toggle="tooltip" title="See how your quotes will look as legal facts before generating">
                    <i class="fas fa-eye"></i> Preview
                </button>
                <button class="btn btn-warning btn-lg" onclick="generateFacts()">
                    <i class="fas fa-plus-circle"></i> Add Video Evidence to Statement of Facts
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preview: Statement of Facts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> This preview shows how your video evidence will appear as numbered facts in the legal document.
                </div>
                <div id="preview-content" style="font-family: 'Times New Roman', serif; line-height: 1.8;">
                    <!-- Preview content loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="generateFacts()">
                    <i class="fas fa-check"></i> Looks Good - Generate Facts
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const DOCUMENT_ID = {{ document.pk }};
const CSRF_TOKEN = '{{ csrf_token }}';

// Time parsing utilities
function parseTimeToSeconds(timeStr) {
    if (!timeStr || timeStr.trim() === '') return null;
    
    // Auto-fix: Replace periods with colons (e.g., "1.05.34" -> "1:05:34")
    timeStr = timeStr.trim().replace(/\./g, ':');
    
    const parts = timeStr.split(':').map(p => parseInt(p, 10));
    
    if (parts.some(isNaN)) return null;
    
    let seconds = 0;
    if (parts.length === 2) {
        // MM:SS
        seconds = parts[0] * 60 + parts[1];
    } else if (parts.length === 3) {
        // HH:MM:SS
        seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
    } else {
        return null;
    }
    
    return seconds >= 0 ? seconds : null;
}

function autoFixTimeFormat(inputId) {
    const input = document.getElementById(inputId);
    if (!input || !input.value) return;
    
    // Replace periods with colons
    const fixed = input.value.trim().replace(/\./g, ':');
    if (fixed !== input.value) {
        input.value = fixed;
        // Update the parsed display
        const displayId = inputId + '-parsed';
        updateParsedTime(inputId, displayId);
    }
}

function secondsToTimeString(seconds) {
    if (seconds === null || seconds < 0) return '';
    
    const hours = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
}

function updateParsedTime(inputId, displayId) {
    const input = document.getElementById(inputId);
    const display = document.getElementById(displayId);
    const seconds = parseTimeToSeconds(input.value);
    
    if (seconds !== null) {
        display.textContent = `✓ ${seconds} seconds`;
        display.className = 'text-success small';
    } else if (input.value.trim() !== '') {
        display.textContent = '✗ Invalid format (use MM:SS or HH:MM:SS)';
        display.className = 'text-danger small';
    } else {
        display.textContent = '';
    }
}

function addDuration(prefix, durationSeconds) {
    const startInput = document.getElementById(`${prefix}-start`);
    const endInput = document.getElementById(`${prefix}-end`);
    
    const startSeconds = parseTimeToSeconds(startInput.value);
    
    if (startSeconds === null) {
        alert('Please enter a valid start time first (format: MM:SS or HH:MM:SS)');
        startInput.focus();
        return;
    }
    
    const endSeconds = startSeconds + durationSeconds;
    endInput.value = secondsToTimeString(endSeconds);
    updateParsedTime(`${prefix}-end`, `${prefix}-end-parsed`);
}

function updateEndFromDuration(prefix) {
    const startInput = document.getElementById(`${prefix}-start`);
    const durationInput = document.getElementById(`${prefix}-duration`);
    const endInput = document.getElementById(`${prefix}-end`);
    
    const startSeconds = parseTimeToSeconds(startInput.value);
    let durationSeconds = parseInt(durationInput.value, 10);
    
    // Check if duration is in MM:SS format
    if (isNaN(durationSeconds) && durationInput.value.includes(':')) {
        durationSeconds = parseTimeToSeconds(durationInput.value);
    }
    
    if (startSeconds === null) {
        alert('Please enter a valid start time first');
        startInput.focus();
        return;
    }
    
    if (isNaN(durationSeconds) || durationSeconds <= 0) {
        alert('Please enter a valid duration in seconds or MM:SS format');
        return;
    }
    
    const endSeconds = startSeconds + durationSeconds;
    endInput.value = secondsToTimeString(endSeconds);
    updateParsedTime(`${prefix}-end`, `${prefix}-end-parsed`);
}

// Extract new segment with AI - WITH AUTO-RETRY
async function extractNewSegment() {
    const MAX_RETRIES = 3;
    const RETRY_DELAY = 2000; // 2 seconds

    const url = document.getElementById('new-url').value.trim();
    const start = document.getElementById('new-start').value.trim();
    const end = document.getElementById('new-end').value.trim();
    const sourceType = document.getElementById('new-source-type').value;
    const statusDiv = document.getElementById('extract-status');
    const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;


    // Validation
    if (!url) {
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Please enter a YouTube URL</div>';
        return;
    }
    
    // Validate YouTube URL format
    if (!youtubeRegex.test(url)) {
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Invalid YouTube URL format. Please use a valid YouTube link like:<br><small>• https://www.youtube.com/watch?v=VIDEO_ID<br>• https://youtu.be/VIDEO_ID</small></div>';
        return;
    }

    // Validate source type is selected
    if (!sourceType) {
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Please select a video source</div>';
        return;
    }

    if (!start || !end) {
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Both start and end times are required</div>';
        return;
    }
    
    // Validate time format
    const startSeconds = parseTimeToSeconds(start);
    const endSeconds = parseTimeToSeconds(end);
    
    if (startSeconds === null) {
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Invalid start time format. Use MM:SS or HH:MM:SS (e.g., 1:05:34)</div>';
        return;
    }
    
    if (endSeconds === null) {
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Invalid end time format. Use MM:SS or HH:MM:SS (e.g., 1:06:28)</div>';
        return;
    }
    
    if (endSeconds <= startSeconds) {
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> End time must be after start time</div>';
        return;
    }

    const duration = endSeconds - startSeconds;
    const durationMinutes = (duration / 60).toFixed(2);

    // Get remaining minutes from document
    const remainingMinutes = {{ document.extraction_minutes_remaining }};

    // Check if enough minutes remaining
    if (parseFloat(durationMinutes) > remainingMinutes) {
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> This segment requires ' + durationMinutes + ' minutes, but you only have ' + remainingMinutes.toFixed(1) + ' minutes remaining. <a href="/accounts/pricing/" class="text-warning"><strong>Upgrade or purchase an add-on bundle</strong></a></div>';
        return;
    }

    // Confirmation dialog
    const confirmMsg = `This will extract ${durationMinutes} minutes of video.\n\nYou have ${remainingMinutes.toFixed(1)} minutes remaining for this document.\n\nAfter extraction, you'll have ${(remainingMinutes - parseFloat(durationMinutes)).toFixed(1)} minutes left.\n\nContinue?`;

    if (!confirm(confirmMsg)) {
        return;
    }

    // Retry loop
    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
        try {
// Show status based on attempt
if (attempt === 1) {
    statusDiv.innerHTML = `<div class="alert alert-info">
        <i class="fas fa-spinner fa-spin"></i> <strong>Extracting transcript...</strong><br>
        <div class="small mt-2">
            <strong>🔍 Step 1:</strong> Checking for YouTube captions (instant if available)<br>
            <strong>🤖 Step 2:</strong> If no captions, using AI transcription (may take 30-60 seconds)<br>
            <em class="text-muted">Please be patient - we're working hard to get your transcript! ☕</em>
        </div>
    </div>`;
} else {
    statusDiv.innerHTML = `<div class="alert alert-warning">
        <i class="fas fa-redo fa-spin"></i> <strong>Retry attempt ${attempt} of ${MAX_RETRIES}</strong><br>
        <small>No captions found, using AI transcription... This can take up to a minute.</small><br>
        <small class="text-muted">Hang tight! We're downloading and processing the audio. ⏳</small>
    </div>`;
}

const response = await fetch(`/documents/${DOCUMENT_ID}/evidence/extract/`, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': CSRF_TOKEN
    },
    body: JSON.stringify({
        youtube_url: url,
        start_time: start,
        end_time: end,
        source_type: sourceType
    })
});

const data = await response.json();
            
            if (data.success) {
                // SUCCESS - Exit retry loop
                statusDiv.innerHTML = `<div class="alert alert-success">
                    <strong>✅ Success!</strong> Segment extracted (${data.duration_minutes.toFixed(2)} minutes).
                    <br><small>📊 Remaining extraction time: ${data.remaining_minutes.toFixed(1)} minutes</small>
                    ${attempt > 1 ? `<br><small>Succeeded on attempt ${attempt}/${MAX_RETRIES}</small>` : ''}
                    <br><small class="text-muted mt-2 d-block">Refreshing in <span id="reload-countdown">3</span> seconds...</small>
                </div>`;
                
                // Countdown timer
                let countdown = 3;
                const countdownInterval = setInterval(() => {
                    const countdownEl = document.getElementById('reload-countdown');
                    if (countdownEl) {
                        countdownEl.textContent = countdown;
                    }
                    countdown--;
                    if (countdown < 0) {
                        clearInterval(countdownInterval);
                        location.reload();
                    }
                }, 1000);
                
                return; // Exit function on success
            }
             else {
                // Failed - check if we should retry
                if (attempt < MAX_RETRIES) {
                    // Wait before retrying
                    statusDiv.innerHTML = `<div class="alert alert-warning">
                        <strong>⚠️ Attempt ${attempt} failed</strong><br>
                        ${data.error}<br>
                        <small>Retrying in ${RETRY_DELAY / 1000} seconds... (${MAX_RETRIES - attempt} attempts remaining)</small>
                    </div>`;
                    await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
                } else {
                    // Final attempt failed
                    statusDiv.innerHTML = `<div class="alert alert-danger">
                        <strong>❌ Extraction failed after ${MAX_RETRIES} attempts</strong><br>
                        ${data.error}<br>
                        <hr>
                        <small class="d-block mt-2">
                            <strong>💡 What to try:</strong><br>
                            • Click "Extract" again (sometimes works on 2nd try)<br>
                            • Use the <strong>Manual Entry</strong> tab instead<br>
                            • Check if the video is private or restricted<br>
                            • Try a different video URL
                        </small>
                    </div>`;
                }
            }
            
        } catch (error) {
            console.error('Network error:', error);
            
            if (attempt < MAX_RETRIES) {
                statusDiv.innerHTML = `<div class="alert alert-warning">
                    <strong>⚠️ Network error on attempt ${attempt}</strong><br>
                    ${error.message}<br>
                    <small>Retrying in ${RETRY_DELAY / 1000} seconds...</small>
                </div>`;
                await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
            } else {
                statusDiv.innerHTML = `<div class="alert alert-danger">
                    <strong>❌ Network error after ${MAX_RETRIES} attempts</strong><br>
                    ${error.message}<br>
                    <small class="d-block mt-2">Please check your internet connection and try again.</small>
                </div>`;
            }
        }
    }
}

// Add manual segment
function addManualSegment() {
    const url = document.getElementById('manual-url').value.trim();
    const start = document.getElementById('manual-start').value.trim();
    const end = document.getElementById('manual-end').value.trim();
    const transcript = document.getElementById('manual-transcript').value.trim();
    const sourceType = document.getElementById('manual-source-type').value;
    const statusDiv = document.getElementById('manual-status');

    // Validation
    if (!url || !transcript) {
        statusDiv.innerHTML = '<div class="alert alert-danger">URL and transcript are required</div>';
        return;
    }

    // Validate source type is selected
    if (!sourceType) {
        statusDiv.innerHTML = '<div class="alert alert-danger">Please select a video source</div>';
        return;
    }

    if (!start || !end) {
        statusDiv.innerHTML = '<div class="alert alert-danger">Both start and end times are required</div>';
        return;
    }
    
    // Validate time format
    const startSeconds = parseTimeToSeconds(start);
    const endSeconds = parseTimeToSeconds(end);
    
    if (startSeconds === null || endSeconds === null) {
        statusDiv.innerHTML = '<div class="alert alert-danger">Invalid time format. Use MM:SS or HH:MM:SS</div>';
        return;
    }
    
    if (endSeconds <= startSeconds) {
        statusDiv.innerHTML = '<div class="alert alert-danger">End time must be after start time</div>';
        return;
    }

    statusDiv.innerHTML = '<div class="alert alert-info">Adding segment...</div>';

    fetch(`/documents/${DOCUMENT_ID}/evidence/add-manual/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify({
            youtube_url: url,
            start_time: start,
            end_time: end,
            transcript: transcript,
            source_type: sourceType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success">Segment added! Refreshing...</div>';
            setTimeout(() => location.reload(), 1000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
        }
    });
}

// Save segment changes
function saveSegment(segmentId) {
    const editedTranscript = document.querySelector(`.edited-transcript[data-segment-id="${segmentId}"]`).value;
    const notes = document.querySelector(`.segment-notes[data-segment-id="${segmentId}"]`).value;
    
    // Get checked violation tags
    const tags = [];
    document.querySelectorAll(`.violation-tag[data-segment-id="${segmentId}"]:checked`).forEach(checkbox => {
        tags.push(checkbox.dataset.tag);
    });

    fetch(`/documents/${DOCUMENT_ID}/evidence/${segmentId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify({
            edited_transcript: editedTranscript,
            notes: notes,
            violation_tags: tags.join(',')
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Changes saved successfully!');
        } else {
            alert('Error: ' + data.error);
        }
    });
}

// Mark as reviewed
function markReviewed(segmentId, newValue) {
    fetch(`/documents/${DOCUMENT_ID}/evidence/${segmentId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify({
            is_reviewed: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// Toggle include in complaint
function toggleInclude(segmentId, newValue) {
    fetch(`/documents/${DOCUMENT_ID}/evidence/${segmentId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF_TOKEN
        },
        body: JSON.stringify({
            include_in_complaint: newValue
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// Delete segment
function deleteSegment(segmentId) {
    if (!confirm('Are you sure you want to delete this segment?')) return;

    fetch(`/documents/${DOCUMENT_ID}/evidence/${segmentId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': CSRF_TOKEN
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// Update sticky action bar when segments are selected/deselected
function updateStickyBar() {
    const checkedBoxes = document.querySelectorAll('.include-in-complaint-checkbox:checked');
    const count = checkedBoxes.length;
    const stickyBar = document.getElementById('sticky-action-bar');
    const countSpan = document.getElementById('selected-count');
    const pluralSpan = document.getElementById('plural-s');
    
    if (count > 0) {
        stickyBar.style.display = 'block';
        countSpan.textContent = count;
        pluralSpan.textContent = count === 1 ? '' : 's';
    } else {
        stickyBar.style.display = 'none';
    }
}

// Preview what the facts will look like
function previewFacts() {
    const previewContent = document.getElementById('preview-content');
    previewContent.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading preview...</div>';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
    
    // Fetch preview from server
    fetch(`/documents/${DOCUMENT_ID}/evidence/preview-facts/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': CSRF_TOKEN
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '<ol>';
            data.facts.forEach(fact => {
                html += `<li class="mb-3">${fact}</li>`;
            });
            html += '</ol>';
            
            if (data.exhibits) {
                html += '<hr><h6 class="mt-4">Exhibits:</h6>';
                html += `<pre class="border p-3 rounded" style="background-color: var(--bs-body-bg); color: var(--bs-body-color);">${data.exhibits}</pre>`;
            }
            
            previewContent.innerHTML = html;
        } else {
            previewContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    })
    .catch(error => {
        previewContent.innerHTML = `<div class="alert alert-danger">Error loading preview: ${error}</div>`;
    });
}

// Generate facts and redirect
function generateFacts() {
    const message = `Add video evidence to Statement of Facts?\n\n` +
                    `✓ Tagged quotes will be converted to narrative paragraphs\n` +
                    `✓ Will be ADDED to your existing Statement of Facts (not replaced)\n` +
                    `✓ A separate "List of Exhibits" section will be created\n\n` +
                    `Continue?`;

    if (confirm(message)) {
        window.location.href = `/documents/${DOCUMENT_ID}/evidence/generate-facts/`;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateStickyBar();

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Load people for all segments
    loadAllPeople();

    // Load quotes for all segments
    document.querySelectorAll('[data-segment-id]').forEach(element => {
        const segmentId = element.getAttribute('data-segment-id');
        if (segmentId) {
            loadQuotes(segmentId);
        }
    });
});

// ==================== PEOPLE MANAGEMENT ====================

let allPeople = [];  // Global store for people

// Load all people involved in the document
async function loadAllPeople() {
    try {
        const response = await fetch(`/documents/${DOCUMENT_ID}/people/`);
        const data = await response.json();
        if (data.success) {
            allPeople = data.people;
        }
    } catch (error) {
        console.error('Error loading people:', error);
    }
}

// Sync people from defendants field
async function syncPeopleFromDefendants() {
    if (!confirm('This will auto-create people from your defendants field. Continue?')) return;

    try {
        const response = await fetch(`/documents/${DOCUMENT_ID}/people/sync/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN
            }
        });
        const data = await response.json();

        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error syncing people: ' + error);
    }
}

// Show add person modal
function showAddPersonModal() {
    document.getElementById('personModalTitle').textContent = 'Add Person';
    document.getElementById('personId').value = '';
    document.getElementById('personName').value = '';
    document.getElementById('personRole').value = 'defendant';
    document.getElementById('personTitle').value = '';
    document.getElementById('personBadgeNumber').value = '';
    document.getElementById('personNotes').value = '';

    const modal = new bootstrap.Modal(document.getElementById('personModal'));
    modal.show();
}

// Edit person
function editPerson(personId) {
    const person = allPeople.find(p => p.id === personId);
    if (!person) return;

    document.getElementById('personModalTitle').textContent = 'Edit Person';
    document.getElementById('personId').value = person.id;
    document.getElementById('personName').value = person.name;
    document.getElementById('personRole').value = person.role;
    document.getElementById('personTitle').value = person.title || '';
    document.getElementById('personBadgeNumber').value = person.badge_number || '';
    document.getElementById('personNotes').value = person.notes || '';

    const modal = new bootstrap.Modal(document.getElementById('personModal'));
    modal.show();
}

// Save person (add or update)
async function savePerson() {
    const personId = document.getElementById('personId').value;
    const name = document.getElementById('personName').value.trim();
    const role = document.getElementById('personRole').value;
    const title = document.getElementById('personTitle').value.trim();
    const badge_number = document.getElementById('personBadgeNumber').value.trim();
    const notes = document.getElementById('personNotes').value.trim();

    if (!name) {
        alert('Name is required');
        return;
    }

    const data = { name, role, title, badge_number, notes };

    const url = personId
        ? `/documents/${DOCUMENT_ID}/people/${personId}/update/`
        : `/documents/${DOCUMENT_ID}/people/add/`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('personModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error saving person: ' + error);
    }
}

// Delete person
async function deletePerson(personId) {
    if (!confirm('Delete this person? This will fail if they have attributed quotes.')) return;

    try {
        const response = await fetch(`/documents/${DOCUMENT_ID}/people/${personId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN
            }
        });

        const data = await response.json();

        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting person: ' + error);
    }
}

// ==================== QUOTE MANAGEMENT ====================

// Enable highlight mode - captures text selection
function enableHighlightMode(segmentId) {
    const textarea = document.querySelector(`.edited-transcript[data-segment-id="${segmentId}"]`);
    const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();

    if (!selectedText) {
        alert('Please select text in the transcript first, then click this button.');
        return;
    }

    // Calculate positions
    const startPos = textarea.selectionStart;
    const endPos = textarea.selectionEnd;

    // Show quote modal
    showQuoteModal(segmentId, selectedText, startPos, endPos);
}

// Show quote attribution modal
function showQuoteModal(segmentId, text, startPos, endPos) {
    // Reload people to ensure we have latest
    loadAllPeople().then(() => {
        if (allPeople.length === 0) {
            alert('No people added yet! Please add people first using the People panel above.');
            return;
        }

        // Set quote data
        document.getElementById('quoteSegmentId').value = segmentId;
        document.getElementById('quoteText').value = text;
        document.getElementById('quoteStartPos').value = startPos;
        document.getElementById('quoteEndPos').value = endPos;

        // Populate speaker dropdown
        const speakerSelect = document.getElementById('quoteSpeaker');
        speakerSelect.innerHTML = '<option value="">-- Select Speaker --</option>';

        allPeople.forEach(person => {
            const option = document.createElement('option');
            option.value = person.id;
            option.textContent = `${person.display_name} (${person.role_display})`;
            speakerSelect.appendChild(option);
        });

        // Clear other fields
        document.getElementById('quoteSignificance').value = '';
        document.getElementById('quoteNotes').value = '';

        // Reset violation checkboxes
        document.querySelectorAll('.violation-checkbox-quote').forEach(cb => cb.checked = false);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('quoteModal'));
        modal.show();
    });
}

// Save quote
async function saveQuote() {
    const segmentId = document.getElementById('quoteSegmentId').value;
    const text = document.getElementById('quoteText').value.trim();
    const startPos = parseInt(document.getElementById('quoteStartPos').value);
    const endPos = parseInt(document.getElementById('quoteEndPos').value);
    const speakerId = document.getElementById('quoteSpeaker').value;
    const significance = document.getElementById('quoteSignificance').value.trim();
    const notes = document.getElementById('quoteNotes').value.trim();

    // Get violation tags
    const violationTags = [];
    document.querySelectorAll('.violation-checkbox-quote:checked').forEach(cb => {
        violationTags.push(cb.value);
    });

    if (!speakerId) {
        alert('Please select a speaker');
        return;
    }

    const data = {
        text,
        start_position: startPos,
        end_position: endPos,
        speaker_id: speakerId,
        significance,
        notes,
        violation_tags: violationTags.join(',')
    };

    try {
        const response = await fetch(`/documents/${DOCUMENT_ID}/evidence/${segmentId}/quotes/add/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('quoteModal')).hide();
            loadQuotes(segmentId);  // Reload quotes for this segment
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error saving quote: ' + error);
    }
}

// Load quotes for a segment
async function loadQuotes(segmentId) {
    try {
        const response = await fetch(`/documents/${DOCUMENT_ID}/evidence/${segmentId}/quotes/`);
        const data = await response.json();

        if (data.success) {
            displayQuotes(segmentId, data.quotes);
        }
    } catch (error) {
        console.error('Error loading quotes:', error);
    }
}

// Display quotes in the UI
function displayQuotes(segmentId, quotes) {
    const container = document.getElementById(`quotes-list-${segmentId}`);
    const countBadge = document.getElementById(`quote-count-${segmentId}`);

    if (!container) return;

    countBadge.textContent = quotes.length;

    if (quotes.length === 0) {
        container.innerHTML = '<p class="text-muted text-center mb-0"><i class="fas fa-info-circle"></i> No quotes tagged yet. Highlight text above to get started.</p>';
        return;
    }

    let html = '';
    quotes.forEach(quote => {
        const colorStyle = `border-left: 4px solid ${quote.speaker.color_code}`;
        html += `
            <div class="card mb-2" style="${colorStyle}">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <blockquote class="mb-1">
                                <i class="fas fa-quote-left text-muted small"></i>
                                <em>${quote.text}</em>
                                <i class="fas fa-quote-right text-muted small"></i>
                            </blockquote>
                            <div>
                                <span class="badge" style="background-color: ${quote.speaker.color_code}">
                                    ${quote.speaker.display_name}
                                </span>
                                ${quote.significance ? `<span class="badge bg-info ms-1">${quote.significance}</span>` : ''}
                                ${quote.violation_tags ? quote.violation_tags.split(',').map(tag =>
                                    `<span class="badge bg-warning text-dark ms-1">${tag.replace('_', ' ')}</span>`
                                ).join('') : ''}
                            </div>
                            ${quote.notes ? `<small class="text-muted d-block mt-1">${quote.notes}</small>` : ''}
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-clock"></i> ${quote.formatted_citation || 'No timestamp'}
                            </small>
                        </div>
                        <div class="btn-group-vertical btn-group-sm ms-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteQuote(${segmentId}, ${quote.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// Delete quote
async function deleteQuote(segmentId, quoteId) {
    if (!confirm('Delete this quote?')) return;

    try {
        const response = await fetch(`/documents/${DOCUMENT_ID}/evidence/${segmentId}/quotes/${quoteId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': CSRF_TOKEN
            }
        });

        const data = await response.json();

        if (data.success) {
            loadQuotes(segmentId);  // Reload quotes
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting quote: ' + error);
    }
}

</script>

<!-- Add/Edit Person Modal -->
<div class="modal fade" id="personModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="personModalTitle">Add Person</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="personId">
                <div class="mb-3">
                    <label class="form-label">Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="personName" placeholder="e.g., John Smith">
                </div>
                <div class="mb-3">
                    <label class="form-label">Role <span class="text-danger">*</span></label>
                    <select class="form-select" id="personRole">
                        <option value="plaintiff">Plaintiff</option>
                        <option value="defendant" selected>Defendant</option>
                        <option value="witness">Witness</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Title/Position</label>
                    <input type="text" class="form-control" id="personTitle" placeholder="e.g., Officer, Detective">
                </div>
                <div class="mb-3">
                    <label class="form-label">Badge Number</label>
                    <input type="text" class="form-control" id="personBadgeNumber" placeholder="e.g., 1234">
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="personNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePerson()">
                    <i class="fas fa-save"></i> Save Person
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Quote Attribution Modal -->
<div class="modal fade" id="quoteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-quote-left"></i> Tag Quote with Speaker
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="quoteSegmentId">
                <input type="hidden" id="quoteStartPos">
                <input type="hidden" id="quoteEndPos">

                <div class="mb-3">
                    <label class="form-label">Selected Quote</label>
                    <textarea class="form-control bg-body-secondary" id="quoteText" rows="3" readonly></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Who said this? <span class="text-danger">*</span></label>
                    <select class="form-select" id="quoteSpeaker">
                        <option value="">-- Select Speaker --</option>
                    </select>
                    <small class="text-muted">Don't see the person? Add them in the People panel above first.</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Significance (optional)</label>
                    <input type="text" class="form-control" id="quoteSignificance" placeholder="e.g., Unlawful demand for ID, Admission of guilt">
                </div>

                <div class="mb-3">
                    <label class="form-label">Related Violations (optional)</label>
                    <div class="form-check">
                        <input class="form-check-input violation-checkbox-quote" type="checkbox" value="first_amendment" id="quote-violation-1st">
                        <label class="form-check-label" for="quote-violation-1st">First Amendment</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input violation-checkbox-quote" type="checkbox" value="fourth_amendment" id="quote-violation-4th">
                        <label class="form-check-label" for="quote-violation-4th">Fourth Amendment</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input violation-checkbox-quote" type="checkbox" value="excessive_force" id="quote-violation-force">
                        <label class="form-check-label" for="quote-violation-force">Excessive Force</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input violation-checkbox-quote" type="checkbox" value="unlawful_detention" id="quote-violation-detention">
                        <label class="form-check-label" for="quote-violation-detention">Unlawful Detention</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Additional Notes (optional)</label>
                    <textarea class="form-control" id="quoteNotes" rows="2" placeholder="Context or additional information about this quote"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveQuote()">
                    <i class="fas fa-save"></i> Save Quote
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}